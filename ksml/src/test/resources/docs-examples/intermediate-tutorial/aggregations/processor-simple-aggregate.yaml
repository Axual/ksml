streams:
  payment_amounts:
    topic: payment_amounts
    keyType: string  # customer_id
    valueType: long  # amount in cents

  payment_totals:
    topic: payment_totals
    keyType: string
    valueType: long

functions:
  init_sum:
    type: initializer
    resultType: long
    code: |
      return 0

  add_value:
    type: aggregator
    resultType: long
    code: |
      return aggregatedValue + value

pipelines:
  calculate_totals:
    from: payment_amounts
    via:
      - type: groupByKey
      - type: aggregate
        store:
          name: payment_totals_store
          type: keyValue
        initializer: init_sum
        aggregator: add_value
      - type: toStream
      - type: peek
        forEach:
          code: |
            log.info("Customer {} total: {}", key, value)
    to: payment_totals