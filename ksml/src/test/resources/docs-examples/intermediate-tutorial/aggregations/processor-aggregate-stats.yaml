streams:
  payment_stream:
    topic: payment_stream
    keyType: string  # customer_id
    valueType: json  # payment details with amount field
    
  payment_statistics:
    topic: payment_statistics
    keyType: string
    valueType: json

functions:
  init_stats:
    type: initializer
    code: |
      # Initialize statistics
      stats = {
        "count": 0,
        "total_amount": 0.0,
        "min_amount": None,
        "max_amount": None
      }
    expression: stats
    resultType: json
    
  update_stats:
    type: aggregator
    code: |
      # Update payment statistics
      if value and aggregatedValue:
        amount = value.get("amount", 0.0)
        aggregatedValue["count"] = aggregatedValue.get("count", 0) + 1
        aggregatedValue["total_amount"] = aggregatedValue.get("total_amount", 0.0) + amount
        
        current_min = aggregatedValue.get("min_amount")
        current_max = aggregatedValue.get("max_amount")
        
        if current_min is None or amount < current_min:
          aggregatedValue["min_amount"] = amount
        if current_max is None or amount > current_max:
          aggregatedValue["max_amount"] = amount
          
        aggregatedValue["average_amount"] = round(aggregatedValue["total_amount"] / aggregatedValue["count"], 2)
    expression: aggregatedValue
    resultType: json

pipelines:
  calculate_statistics:
    from: payment_stream
    via:
      - type: groupByKey
      - type: aggregate
        store:
          type: keyValue
          retention: 1h
          caching: false
        initializer: init_stats
        aggregator: update_stats
      - type: toStream
      - type: peek
        forEach:
          code: |
            if value:
              count = value.get("count", 0)
              total = round(value.get("total_amount", 0), 2)
              avg = value.get("average_amount", 0)
              min_amt = value.get("min_amount", 0)
              max_amt = value.get("max_amount", 0)
              log.info("Customer {} - Count: {}, Total: ${}, Avg: ${}, Min: ${}, Max: ${}", 
                       key, count, total, avg, min_amt, max_amt)
    to: payment_statistics