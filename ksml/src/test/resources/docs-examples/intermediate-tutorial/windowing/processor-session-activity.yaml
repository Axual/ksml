streams:
  user_clicks:
    topic: user_clicks
    keyType: string
    valueType: json
    
  user_sessions:
    topic: user_session_summary
    keyType: json:windowed(string)  
    valueType: long

functions:

pipelines:
  user_session_analysis:
    from: user_clicks
    via:
      - type: groupByKey
      - type: windowBySession
        inactivityGap: 2m  # Close session after 2 minutes of inactivity
        grace: 30s
      - type: count
        store:
          name: user_sessions
          type: session
          retention: 1h
          caching: false
      - type: toStream
      - type: convertKey
        into: json:windowed(string)
      - type: peek
        forEach:
          code: log.info("USER SESSION - user={}, clicks={}", key, value)
    to: user_sessions