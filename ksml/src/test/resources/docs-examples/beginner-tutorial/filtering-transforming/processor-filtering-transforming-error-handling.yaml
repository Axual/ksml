streams:
  input_stream:
    topic: tutorial_input
    keyType: string
    valueType: json
  alerts_stream:
    topic: alerts_stream
    keyType: string
    valueType: json

functions:
  safe_filter:
    type: predicate
    code: |
      try:
        sensors = value.get('sensors', {})
        temperature = sensors.get('temperature')
        humidity = sensors.get('humidity')
      
        if temperature is None or humidity is None:
          log.warn("Missing required fields in message: {}", value)
          return False
      
        return temperature > 70 and humidity < 50
      except Exception as e:
        log.error("Error in filter: {} - Message: {}", str(e), value)
        return False

pipelines:
  robust_filtering:
    from: input_stream
    via:
      - type: filter
        if: safe_filter
    to: alerts_stream