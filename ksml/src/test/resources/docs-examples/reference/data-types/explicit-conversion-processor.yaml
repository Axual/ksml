# Demonstrates explicit format conversion in KSML
# 
# This example shows that KSML requires explicit conversion operations when
# outputting to a stream with a different format type. Without explicit conversion,
# KSML will fail with a type mismatch error at the pipeline sink.

streams:
  json_input:
    topic: json_messages
    keyType: string
    valueType: json
    offsetResetPolicy: earliest
  
  # Output stream with different format - requires explicit conversion
  string_output:
    topic: string_messages
    keyType: string
    valueType: string

pipelines:
  explicit_conversion_pipeline:
    from: json_input
    via:
      # Log the incoming JSON data
      - type: peek
        forEach:
          code: |
            log.info("JSON input - sensor: {}, city: {}, type: {}, value: {}{}",
                     value.get("sensor_id"), value.get("city"), 
                     value.get("type"), value.get("value"), value.get("unit"))
      
      # REQUIRED: Explicit conversion from JSON to string
      # Without this, KSML will fail with:
      # "Target topic valueType is expected to be type json, but found string"
      - type: convertValue
        into: string
      
      # Log the converted string data
      - type: peek
        forEach:
          code: |
            log.info("String output - sensor: {}, data: {}", key, value[:100] if len(value) > 100 else value)
    
    # Output to string format stream
    to: string_output