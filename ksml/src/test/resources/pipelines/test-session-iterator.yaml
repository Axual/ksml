# $schema: https://raw.githubusercontent.com/Axual/ksml/refs/heads/main/docs/ksml-language-spec.json

# pipeline which accesses iterator methods on return type from session store
streams:
  sensor_source:
    topic: sensor_ownership_data
    keyType: string
    valueType: string
    offsetResetPolicy: latest

stores:
  session_store:
    type: session
    keyType: string
    valueType: string
    retention: 1h
    persistent: false
    caching: false
    logging: false

functions:
  test_session_iterator:
    type: forEach
    code: |
      import time

      log.info("=== TEST: Session Store Iterator Functionality")
      log.info("Processing: key={}, value={}", key, value)

      # Test KeyValueIterator from fetch(key)
      log.info("Attempting to call session_store.fetch(key)...")
      try:
        iterator = session_store.fetch(key)
        log.info("SUCCESS: Got KeyValueIterator from fetch()")

        log.info("Attempting to call iterator.hasNext()...")
        try:
          has_next = iterator.hasNext()
          log.info("SUCCESS: hasNext() returned: {}", has_next)

          if has_next:
            log.info("Attempting to call iterator.next()...")
            try:
              entry = iterator.next()
              log.info("SUCCESS: next() returned an entry")
              log.info("Entry type: {}", type(entry))
            except Exception as e:
              log.error("FAIL: iterator.next() failed: {}", str(e))
        except Exception as e:
          log.error("FAIL: iterator.hasNext() failed: {}", str(e))

        try:
          iterator.close()
        except Exception as e:
          log.warn("Could not close iterator: {}", str(e))

      except Exception as e:
        log.error("FAIL: session_store.fetch() failed: {}", str(e))

      # Test KeyValueIterator from findSessions(key, earliestSessionEndTime, latestSessionStartTime)
      log.info("Attempting to call session_store.findSessions(key, ...)...")
      try:
        now_ms = int(time.time() * 1000)
        thirty_minutes_ms = 30 * 60 * 1000
        time_from = now_ms - thirty_minutes_ms
        time_to = now_ms + thirty_minutes_ms
        find_iterator = session_store.findSessions(key, time_from, time_to)
        log.info("SUCCESS: Got KeyValueIterator from findSessions()")

        log.info("Attempting to call find_iterator.hasNext()...")
        try:
          has_next = find_iterator.hasNext()
          log.info("SUCCESS: hasNext() returned: {}", has_next)

          if has_next:
            log.info("Attempting to call find_iterator.next()...")
            try:
              entry = find_iterator.next()
              log.info("SUCCESS: next() returned an entry")
              log.info("Entry type: {}", type(entry))
            except Exception as e:
              log.error("FAIL: find_iterator.next() failed: {}", str(e))
        except Exception as e:
          log.error("FAIL: find_iterator.hasNext() failed: {}", str(e))

        try:
          find_iterator.close()
        except Exception as e:
          log.warn("Could not close iterator: {}", str(e))

      except Exception as e:
        log.error("FAIL: session_store.findSessions() failed: {}", str(e))
    stores:
      - session_store

pipelines:
  test_session_iterator_pipeline:
    from: sensor_source
    forEach: test_session_iterator
