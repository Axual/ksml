# --- step 1: build the code on GraalVM
FROM ghcr.io/graalvm/graalvm-ce:22.3.0 AS builder
MAINTAINER Axual <maintainer@axual.io>
WORKDIR /
RUN curl -O https://archive.apache.org/dist/maven/maven-3/3.8.5/binaries/apache-maven-3.8.5-bin.tar.gz \
  && tar xvf apache-maven-3.8.5-bin.tar.gz \
  && gu install python
ADD . /project_dir
RUN cd /project_dir && /apache-maven-3.8.5/bin/mvn clean package

# --- step 2: build GraalVM image with compiled code
FROM redhat/ubi8:8.6-990
ENV JAVA_HOME=/opt/graalvm
ENV PATH=/opt/graalvm/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# --- specify one of [ksml-runner, ksml-runner-axual]; ksml-runner is default
ARG runner=ksml-runner


RUN echo Building runner: $runner
COPY --from=builder /usr/java/latest/ /opt/graalvm

RUN mkdir -p "/opt/ksml/libs"  \
  && chown -R 1024:users /opt \
  && chown -R 1024:users /tmp \
  && /opt/graalvm/bin/gu -A install python

COPY --chown=1024 --from=builder /project_dir/$runner/target/libs/ /opt/ksml/libs/
COPY --chown=1024 --from=builder /project_dir/$runner/target/ksml-runner*.jar /opt/ksml/ksml.jar

WORKDIR /opt/ksml
USER 1024
ENTRYPOINT ["java", "-jar", "/opt/ksml/ksml.jar"]
